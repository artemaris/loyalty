# GopherMart API Documentation

## Обзор

GopherMart API предоставляет RESTful интерфейс для системы лояльности. Все ответы возвращаются в формате JSON, если не указано иное.

## Аутентификация

API использует JWT токены для аутентификации. Токен должен передаваться в заголовке `Authorization` в формате:
```
Authorization: Bearer <token>
```

## Endpoints

### 1. Регистрация пользователя

**POST** `/api/user/register`

Регистрирует нового пользователя и автоматически аутентифицирует его.

**Request Body:**
```json
{
    "login": "user@example.com",
    "password": "password123"
}
```

**Response:**
- `200 OK` - Пользователь успешно зарегистрирован
- `400 Bad Request` - Неверный формат запроса
- `409 Conflict` - Логин уже занят
- `500 Internal Server Error` - Внутренняя ошибка сервера

### 2. Вход пользователя

**POST** `/api/user/login`

Аутентифицирует существующего пользователя.

**Request Body:**
```json
{
    "login": "user@example.com",
    "password": "password123"
}
```

**Response:**
- `200 OK` - Пользователь успешно аутентифицирован
- `400 Bad Request` - Неверный формат запроса
- `401 Unauthorized` - Неверная пара логин/пароль
- `500 Internal Server Error` - Внутренняя ошибка сервера

### 3. Загрузка номера заказа

**POST** `/api/user/orders`

Загружает номер заказа для обработки. Требует аутентификации.

**Request Body:** `text/plain`
```
12345678903
```

**Response:**
- `200 OK` - Номер заказа уже был загружен этим пользователем
- `202 Accepted` - Новый номер заказа принят в обработку
- `400 Bad Request` - Неверный формат запроса
- `401 Unauthorized` - Пользователь не аутентифицирован
- `409 Conflict` - Номер заказа уже был загружен другим пользователем
- `422 Unprocessable Entity` - Неверный формат номера заказа
- `500 Internal Server Error` - Внутренняя ошибка сервера

### 4. Получение списка заказов

**GET** `/api/user/orders`

Возвращает список заказов пользователя. Требует аутентификации.

**Response:**
- `200 OK` - Список заказов
```json
[
    {
        "number": "9278923470",
        "status": "PROCESSED",
        "accrual": 500,
        "uploaded_at": "2020-12-10T15:15:45+03:00"
    },
    {
        "number": "12345678903",
        "status": "PROCESSING",
        "uploaded_at": "2020-12-10T15:12:01+03:00"
    }
]
```
- `204 No Content` - Нет данных для ответа
- `401 Unauthorized` - Пользователь не аутентифицирован
- `500 Internal Server Error` - Внутренняя ошибка сервера

### 5. Получение баланса

**GET** `/api/user/balance`

Возвращает текущий баланс пользователя. Требует аутентификации.

**Response:**
- `200 OK`
```json
{
    "current": 500.5,
    "withdrawn": 42
}
```
- `401 Unauthorized` - Пользователь не аутентифицирован
- `500 Internal Server Error` - Внутренняя ошибка сервера

### 6. Списание баллов

**POST** `/api/user/balance/withdraw`

Списывает баллы с баланса пользователя. Требует аутентификации.

**Request Body:**
```json
{
    "order": "2377225624",
    "sum": 751
}
```

**Response:**
- `200 OK` - Списание выполнено успешно
- `400 Bad Request` - Неверный формат запроса
- `401 Unauthorized` - Пользователь не аутентифицирован
- `402 Payment Required` - Недостаточно средств
- `422 Unprocessable Entity` - Неверный номер заказа
- `500 Internal Server Error` - Внутренняя ошибка сервера

### 7. Получение истории списаний

**GET** `/api/user/withdrawals`

Возвращает историю списаний пользователя. Требует аутентификации.

**Response:**
- `200 OK`
```json
[
    {
        "order": "2377225624",
        "sum": 500,
        "processed_at": "2020-12-09T16:09:57+03:00"
    }
]
```
- `204 No Content` - Нет списаний
- `401 Unauthorized` - Пользователь не аутентифицирован
- `500 Internal Server Error` - Внутренняя ошибка сервера

## Статусы заказов

- `NEW` - Заказ загружен в систему, но не попал в обработку
- `PROCESSING` - Вознаграждение за заказ рассчитывается
- `INVALID` - Система расчёта вознаграждений отказала в расчёте
- `PROCESSED` - Данные по заказу проверены и информация о расчёте успешно получена

## Алгоритм Луна

Номера заказов проверяются с помощью алгоритма Луна для валидации контрольных цифр.

## Сжатие

API поддерживает сжатие ответов с помощью gzip. Клиент должен передавать заголовок `Accept-Encoding: gzip` для получения сжатых ответов.

## Обработка ошибок

Все ошибки возвращаются с соответствующими HTTP статус кодами. Тело ответа может содержать описание ошибки в формате JSON:

```json
{
    "error": "Описание ошибки"
}
``` 